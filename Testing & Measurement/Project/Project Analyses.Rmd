---
title: "R Notebook - Belief in Change Scale Analyses"
output:
  html_notebook:
    toc: yes
    toc_depth: 5
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '5'
---

# Load libraries 
```{r, message = FALSE}
library(psych)
# install.packages("GPArotation")
library(GPArotation)
library(lavaan)
library(semTools)
# install.packages("tidyverse")
library(tidyverse)
```

# Import data
```{r}
data <- read.csv("Class Survey Data.csv", header = TRUE, stringsAsFactors = FALSE)
```

# Subset the data - our scale + convergent + Big 5 + demographics 
```{r}
data2 <- data %>%
  select(starts_with("change"), starts_with("pc_comm"), starts_with("lo"), starts_with("lc"), starts_with("bf"), Age, Sex, Sex_3_TEXT, Race, Race_6_TEXT, Hispanic)
```

# Reverse-coding - our scale + convergent
```{r}
data2 <- data2 %>%
  mutate(change1_2R = 6-change1_2, change1_4R = 6-change1_4, change1_6R = 6-change1_6, change1_9R = 6-change1_9, change2_2R = 6-change2_2, change2_5R = 6-change2_5, change2_7R = 6-change2_7, change2_9R = 6-change2_9, lo_2R = 6-lo_2, lo_4R = 6-lo_4, lo_5R = 6-lo_5, lc_2R = 6-lc_2, lc_4R = 6-lc_4, lc_6R = 6-lc_6)
```

# Subset the data (just our scale)
```{r}
change <- data2 %>%
  select(change1_1, change1_2R, change1_3, change1_4R, change1_5, change1_6R, change1_7, change1_8, change1_9R, change2_1, change2_2R, change2_3, change2_4, change2_5R, change2_6, change2_7R, change2_8, change2_9R, change2_10)
```

## Descriptive stats for demographics 
```{r}
# age descriptives
describe(data$Age)

# sex frequency + propotion
table(data$Sex,exclude=NULL)
prop.table(table(data$Sex))

# race frequency + propotion
table(data$Race,exclude=NULL)
prop.table(table(data$Race))

# hisp frequency + propotion
table(data$Hispanic, exclude=NULL)
prop.table(table(data$Hispanic))
```

## Descriptive stats for scale items 
```{r}
describe(change)
```

# Interitem and tem-total correlations (discrimination)
## Subset data 
did this so we can just run the cor() function on all variables in the data set
```{r}
change2 <- change %>%
  select(change1_1, change1_2R, change1_3, change1_4R, change1_5, change1_6R, change1_7, change1_8, change1_9R, change2_1, change2_2R, change2_3, change2_4, change2_5R, change2_6, change2_7R, change2_8, change2_9R, change2_10)
```

## Create scale scores 
```{r}
# average for full scale 
change2$scalefull <- rowMeans(change2[ , c("change1_1", "change1_2R", "change1_3", "change1_4R", "change1_5", "change1_6R", "change1_7", "change1_8", "change1_9R", "change2_1", "change2_2R", "change2_3", "change2_4", "change2_5R", "change2_6", "change2_7R", "change2_8", "change2_9R", "change2_10")])

# average for general belief subscale
change2$scalegeneral <- rowMeans(change2[ , c("change1_1", "change1_2R", "change1_3", "change1_4R", "change1_5", "change1_6R", "change1_7", "change1_8", "change1_9R")])

# average for personal subscale 
change2$scalepersonal <- rowMeans(change2[ , c("change2_1", "change2_2R", "change2_3", "change2_4", "change2_5R", "change2_6", "change2_7R", "change2_8", "change2_9R", "change2_10")])
```

## Interitem and item-total correlations 
```{r}
itemtotal <- cor(change2, use = "pairwise.complete.obs")
itemtotal
```

## Descriptive stats for scale items and scale scores
(reran to get descriptives for scale scores too)
```{r}
describe(change2)
```

# Interitem correlations (write to CSV)
```{r}
cortable <- cor(change, use = "pairwise.complete.obs")
write.csv(cortable, file = "Cor Table.csv")
```

# Factor Analysis
## All items
### CFA - two factor no items removed

```{r}
model.2f <- 'f1 =~ change1_1 + change1_2R + change1_3 + change1_4R + change1_5 + change1_6R + change1_7 + change1_8 + change1_9R
            f2 =~ change2_1 + change2_2R + change2_3 + change2_4 + change2_5R + change2_6 + change2_7R + change2_8 + change2_9R + change2_10'

fit.model.2f <- cfa(model.2f, change)
summary(fit.model.2f, fit.measures = TRUE, standardized = TRUE)


resid(fit.model.2f, type = "cor")

reliability(fit.model.2f)
```


### EFA - no items removed 
#### Scree plot 
```{r}
set.seed(123)
parallel = fa.parallel(change,
 fm = 'ml',
 fa = 'fa',
 n.iter = 50,
 main = "Scree plot of scale",
 SMC = TRUE)
```

#### EFA - all items - one factor 
```{r}
efa_full_1 <- fa(change, nfactors = 1, fm = "ml", rotate = "geominQ")

chi_full_1 <- efa_full_1$chi # <- #get Chi square value
dof_full_1 <- efa_full_1$dof # <- Getting degrees of freedom

efa_full_1
```

#### EFA - all items - two factors 
```{r}


efa_full_2 <- fa(change, nfactors = 2, fm = "ml", rotate = "geominQ")

chi_full_2 <- efa_full_2$chi # <- #get Chi square value
dof_full_2 <- efa_full_2$dof # <- Getting degrees of freedom

efa_full_2
```

#### EFA - all items - three factors
```{r}
efa_full_3 <- fa(change, nfactors = 3, fm = "ml", rotate = "geominQ")

chi_full_3 <- efa_full_3$chi # <- #get Chi square value
dof_full_3 <- efa_full_3$dof # <- Getting degrees of freedom

efa_full_3
```


#### 1-factor & 2-factor Model Comparison
```{r}

chi_diff <- chi_full_1 - chi_full_2
dof_diff <- dof_full_1 - dof_full_2

pchisq(chi_diff, df=dof_diff, lower.tail = FALSE)

```
The p-value for a chi-square difference (X^2 = 245.24, df = 18) test  of 7.550373e-422 is an indication that the the 2-factor model has a much better fit than the 1-factor model.

#### 2-factor & 3-factor Model Comparison
```{r}

chi_diff <- chi_full_2 - chi_full_3
dof_diff <- dof_full_2 - dof_full_3

pchisq(chi_diff, df=dof_diff, lower.tail = FALSE)

```
The p-value for a chi-square difference (X^2 = 82.78, df = 17) test  of 1.227792e-10 is an indication that the the 3-factor model has a much better fit than the 2-factor model.


### CFA - one factor
```{r}
model.1f <- 'f1 =~ change1_1 + change1_2R + change1_3 + change1_4R + change1_5 + change1_6R + change1_7 + change1_8 + change1_9R + change2_1 + change2_2R + change2_3 + change2_4 + change2_5R + change2_6 + change2_7R + change2_8 + change2_9R + change2_10'

fit.model.1f <- cfa(model.1f, change)
summary(fit.model.1f, fit.measures = TRUE, standardized = TRUE)

resid(fit.model.1f, type = "cor")
```

## Removing items
### CFA -two factor without items 1_2R and 2_4
```{r}
model.2f2 <- 'f1 =~ change1_1 + change1_3 + change1_4R + change1_5 + change1_6R + change1_7 + change1_8 + change1_9R
            f2 =~ change2_1 + change2_2R + change2_3 + change2_5R + change2_6 + change2_7R + change2_8 + change2_9R + change2_10'

fit.model.2f2 <- cfa(model.2f2, change)
summary(fit.model.2f2, fit.measures = TRUE, standardized = TRUE)

resid(fit.model.2f2, type = "cor")

reliability(fit.model.2f2)
```

### CFA -two factor without items 1_2R, 1_3, and 2_4 
```{r}
model.2f3 <- 'f1 =~ change1_1 + change1_4R + change1_5 + change1_6R + change1_7 + change1_8 + change1_9R
            f2 =~ change2_1 + change2_2R + change2_3 + change2_5R + change2_6 + change2_7R + change2_8 + change2_9R + change2_10'

fit.model.2f3 <- cfa(model.2f3, change)
summary(fit.model.2f3, fit.measures = TRUE, standardized = TRUE)

resid(fit.model.2f3, type = "cor")

reliability(fit.model.2f3)
```

### CFA -two factor without items 1_2R, 1_3, 1_7, 2_4, 2_6
```{r}
model.2f4 <- 'f1 =~ change1_1 + change1_4R + change1_5 + change1_6R + change1_8 + change1_9R
            f2 =~ change2_1 + change2_2R + change2_3 + change2_5R + change2_7R + change2_8 + change2_9R + change2_10'

fit.model.2f4 <- cfa(model.2f4, change)
summary(fit.model.2f4, fit.measures = TRUE, standardized = TRUE)

resid(fit.model.2f4, type = "cor")

reliability(fit.model.2f4)
```

### CFA -two factor without items 1_2R, 1_3, 1_7, 2_3, 2_4, 2_6, 2_8
```{r}
model.2f5 <- 'f1 =~ change1_1 + change1_4R + change1_5 + change1_6R + change1_8 + change1_9R
            f2 =~ change2_1 + change2_2R + change2_5R + change2_7R + change2_9R + change2_10'

fit.model.2f5 <- cfa(model.2f5, change)
summary(fit.model.2f5, fit.measures = TRUE, standardized = TRUE)

resid(fit.model.2f5, type = "cor")

reliability(fit.model.2f5)
```

### CFA -two factor without items 1_2R, 1_3, 1_7, 2_3, 2_4, 2_6, 2_8, 2_9R
```{r}
model.2f6 <- 'f1 =~ change1_1 + change1_4R + change1_5 + change1_6R + change1_8 + change1_9R
            f2 =~ change2_1 + change2_2R + change2_5R + change2_7R + change2_10'

fit.model.2f6 <- cfa(model.2f6, change)
summary(fit.model.2f6, fit.measures = TRUE, standardized = TRUE)

resid(fit.model.2f6, type = "cor")

reliability(fit.model.2f6)
```

### CFA -one factor without items 1_2R, 1_3, 1_7, 2_3, 2_4, 2_6, 2_8, 2_9R
```{r}
model.1f6 <- 'f1 =~ change1_1 + change1_4R + change1_5 + change1_6R + change1_8 + change1_9R + change2_1 + change2_2R + change2_5R + change2_7R + change2_10'

fit.model.1f6 <- cfa(model.1f6, change)
summary(fit.model.1f6, fit.measures = TRUE, standardized = TRUE)

resid(fit.model.1f6, type = "cor")

reliability(fit.model.1f6)
```

## EFA - after all items removed 
### Create new dataframe with kept items 
```{r}
changefinal <- change %>%
  select(change1_1, change1_4R, change1_5, change1_6R, change1_8, change1_9R, change2_1, change2_2R, change2_5R, change2_7R, change2_10)
```

#### EFA - items removed - one factor
```{r}
efa_fi_1 <- fa(changefinal, nfactors = 1, fm = "ml", rotate = "geominQ")

chi_fi_1 <- efa_fi_1$chi # <- Getting Chi square value
dof_fi_1 <- efa_fi_1$dof # <- Getting degrees of freedom

efa_fi_1
```

#### EFA - items removed - two factors
```{r}
efa_fi_2 <- fa(changefinal, nfactors = 2, fm = "ml", rotate = "geominQ")

chi_fi_2 <- efa_fi_2$chi # <- #get Chi square value
dof_fi_2 <- efa_fi_2$dof # <- Getting degressod of freedom

efa_fi_2
```


#### EFA - items removed - three factors
```{r}
efa_fi_3 <- fa(changefinal, nfactors = 3, fm = "ml", rotate = "geominQ")

chi_fi_3 <- efa_fi_3$chi # <- #get Chi square value
dof_fi_3 <- efa_fi_3$dof # <- Getting degrees of freedom

efa_fi_3
```

#### 1-factor & 2-factor Model Comparison

```{r}

chi_diff <- chi_fi_1 - chi_fi_2
dof_diff <- dof_fi_1 - dof_fi_2

pchisq(chi_diff, df=dof_diff, lower.tail=FALSE)

```
The p-value for a chi-square difference (X^2 = 124.07, df = 10) test  of 7.549636e-22 is an indication that the the 2-factor model has a much better fit than the 1-factor model.

#### 2-factor & 3-factor comparison

```{r}

chi_diff <- chi_fi_2 - chi_fi_3
dof_diff <- dof_fi_2 - dof_fi_3

pchisq(chi_diff, df=dof_diff, lower.tail=FALSE)

```
The p-value for a chi-square difference (X^2 = 12.49, df = 9) test of 0.1870661 is an indication that the the 3-factor model does **NOT** have a better fit than the 2 factor model.

# Convergent measures 
## Reverse code convergent items 
```{r}
data2 <- data2 %>%
  mutate(pc_comm_1R = 6-pc_comm_1, BF1_22R = 7-BF1_22, BF2_9R = 7-BF2_9, BF2_14R = 7-BF2_14, BF2_19R = 7-BF2_19, BF2_25R = 7-BF2_25, BF2_10R = 7-BF2_10, BF2_15R = 7-BF2_15, BF2_18R = 7-BF2_18, BF2_24R = 7-BF2_24, BF2_11R = 7-BF2_11, BF2_16R = 7-BF2_16, BF2_13R = 7-BF2_13, BF2_1R = 7-BF2_1, BF1_17R = 7-BF1_17, BF1_18R = 7-BF1_18, BF2_5R = 7-BF2_5, BF2_6R = 7-BF2_6, BF2_12R = 7-BF2_12, BF2_21R = 7-BF2_21, BF2_3R = 7-BF2_3, BF2_20R = 7-BF2_20, BF2_23R = 7-BF2_23, BF2_22R = 7-BF2_22, BF2_2R = 7-BF2_2)
```

## CFA - Big Five
```{r}
modelBF <- 'f1 =~ BF1_2 + BF1_7 + BF1_11 + BF1_12 + BF1_23 + BF1_24 + BF2_10R + BF2_15R + BF2_18R + BF2_24R
f2 =~ BF1_3 + BF1_8 + BF1_13 + BF1_14 + BF1_25 + BF2_1R + BF2_4 + BF2_11R + BF2_13R + BF2_16R
f3 =~ BF1_1 + BF1_6 + BF1_15 + BF1_16 + BF1_21 + BF1_22R + BF2_9R + BF2_14R + BF2_19R + BF2_25R
f4 =~ BF1_5 + BF1_10 + BF1_19 + BF1_20 + BF2_2R + BF2_7 + BF2_8 + BF2_17 + BF2_22R + BF2_23R
f5 =~ BF1_4 + BF1_9 + BF1_17R + BF1_18R + BF2_3R + BF2_5R + BF2_6R + BF2_12R + BF2_20R + BF2_21R'

fit.modelBF <- cfa(modelBF, data2)
summary(fit.modelBF, fit.measures = TRUE, standardized = TRUE)

resid(fit.modelBF, type = "cor")

reliability(fit.modelBF)
```

## CFA - perceived control at community level 
```{r}
model.PC <- 'f1 =~ pc_comm_1 + pc_comm_2 + pc_comm_3 + pc_comm_4 + pc_comm_5'

fit.model.PC <- cfa(model.PC, data2)
summary(fit.model.PC, fit.measures = TRUE, standardized = TRUE)

resid(fit.model.PC, type = "cor")
reliability(fit.model.PC)
```

## CFA - optimism 
```{r}
model.LO <- 'f1 =~ lo_1 + lo_2R + lo_3 + lo_4R + lo_5R + lo_6'

fit.model.LO <- cfa(model.LO, data2)
summary(fit.model.LO, fit.measures = TRUE, standardized = TRUE)

resid(fit.model.LO, type = "cor")
reliability(fit.model.LO)
```

## CFA - locus of control  
```{r}
model.LC <- 'f1 =~ lc_1 + lc_2R + lc_3 + lc_4R + lc_5 + lc_6R'

fit.model.LC <- cfa(model.LC, data2)
summary(fit.model.LC, fit.measures = TRUE, standardized = TRUE)

resid(fit.model.LC, type = "cor")
reliability(fit.model.LC)
```

## Calculate convergent scale scores 
```{r}
# perceived control at comm level
data2$scalePC <- rowMeans(data2[ , c("pc_comm_1", "pc_comm_2", "pc_comm_3", "pc_comm_4","pc_comm_5")])

# life orientation (optimism)
data2$scaleLO <- rowMeans(data2[ , c("lo_1", "lo_2R", "lo_3", "lo_4R", "lo_5R", "lo_6")])

# locus of control 
data2$scaleLC <- rowMeans(data2[ , c("lc_1", "lc_2R", "lc_3", "lc_4R", "lc_5", "lc_6R")])

# agreeableness
data2$scaleagree <- rowMeans(data2[ , c("BF1_2", "BF1_7", "BF1_11", "BF1_12", "BF1_23", "BF1_24", "BF2_10R", "BF2_15R", "BF2_18R", "BF2_24R")])
                                        
# conscientiousness
data2$scalecons <- rowMeans(data2[ , c("BF1_3", "BF1_8", "BF1_13", "BF1_14", "BF1_25", "BF2_1R", "BF2_4", "BF2_11R", "BF2_13R", "BF2_16R")])
                                       
# extraversion 
data2$scaleextra <- rowMeans(data2[ , c("BF1_1", "BF1_6", "BF1_15", "BF1_16", "BF1_21", "BF1_22R", "BF2_9R", "BF2_14R", "BF2_19R", "BF2_25R")])
                                        
# openness/intellect
data2$scaleopen <- rowMeans(data2[ , c("BF1_5", "BF1_10", "BF1_19", "BF1_20", "BF2_2R", "BF2_7", "BF2_8", "BF2_17", "BF2_22R", "BF2_23R")])
                                       
# emotional stability 
data2$scaleemot <- rowMeans(data2[ , c("BF1_4", "BF1_9", "BF1_17R", "BF1_18R", "BF2_3R", "BF2_5R", "BF2_6R", "BF2_12R", "BF2_20R", "BF2_21R")])

# scale scores for full scale and subscales in full dataset 
## previously they were calculated in the dataset with only our scale
data2$scalefull <- rowMeans(data2[ , c("change1_1", "change1_2R", "change1_3", "change1_4R", "change1_5", "change1_6R", "change1_7", "change1_8", "change1_9R", "change2_1", "change2_2R", "change2_3", "change2_4", "change2_5R", "change2_6", "change2_7R", "change2_8", "change2_9R", "change2_10")])
data2$scalegeneral <- rowMeans(data2[ , c("change1_1", "change1_2R", "change1_3", "change1_4R", "change1_5", "change1_6R", "change1_7", "change1_8", "change1_9R")])
data2$scalepersonal <- rowMeans(data2[ , c("change2_1", "change2_2R", "change2_3", "change2_4", "change2_5R", "change2_6", "change2_7R", "change2_8", "change2_9R", "change2_10")])
  
```

## Subset the data - all scale scores 
(to easily correlate all scales)
```{r}
dataSS <- data2 %>%
  select(scalefull, scalegeneral, scalepersonal, scalePC, scaleLO, scaleLC, scaleagree, scalecons, scaleextra, scaleopen, scaleemot)
```

## Correlation table for all variables 
```{r}
cor(dataSS, use = "pairwise.complete.obs")
```

```{r}
psych::alpha(change)

```

